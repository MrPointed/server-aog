Private Sub HandleLoginExistingChar(ByVal Userindex As Integer)

    '***************************************************
    'Author: Juan Martin Sotuyo Dodero (Maraxus)
    'Last Modification: 05/17/06
    '
    '***************************************************
    If UserList(Userindex).incomingData.Length < 6 Then
        Err.Raise UserList(Userindex).incomingData.NotEnoughDataErrCode
        Exit Sub

    End If
    
    On Error GoTo errHandler

    'This packet contains strings, make a copy of the data to prevent losses if it's not complete yet...
    Dim buffer As clsByteQueue
    Set buffer = New clsByteQueue
    Call buffer.CopyBuffer(UserList(Userindex).incomingData)
    
    'Remove packet ID
    Call buffer.ReadByte

    Dim UserName    As String
    Dim AccountHash As String
    Dim version     As String
    
    UserName = buffer.ReadASCIIString()
    AccountHash = buffer.ReadASCIIString()
    
    'Convert version number to string
    version = CStr(buffer.ReadByte()) & "." & CStr(buffer.ReadByte()) & "." & CStr(buffer.ReadByte())
    
    'If we got here then packet is complete, copy data back to original queue
    Call UserList(Userindex).incomingData.CopyBuffer(buffer)
                
    If Not AsciiValidos(UserName) Then
        Call WriteErrorMsg(Userindex, "Nombre invalido.")
        Call CloseSocket(Userindex)
        
        Exit Sub

    End If
    
    If Not PersonajeExiste(UserName) Then
        Call WriteErrorMsg(Userindex, "El personaje no existe.")
        Call CloseSocket(Userindex)
        
        Exit Sub

    End If

    If BANCheck(UserName) Then
        Call WriteErrorMsg(Userindex, "Se te ha prohibido la entrada a Argentum Online debido a tu mal comportamiento. Puedes consultar el reglamento y el sistema de soporte desde www.argentumonline.org")
    ElseIf Not VersionOK(version) Then
        Call WriteErrorMsg(Userindex, "Esta version del juego es obsoleta, la ultima version es la " & ULTIMAVERSION & ". Tu Version " & version & ". La misma se encuentra disponible en www.argentumonline.org")
    Else
        Call ConnectUser(Userindex, UserName, AccountHash)
    End If
 
errHandler:

    Dim Error As Long

    Error = Err.Number

    On Error GoTo 0
    
    'Destroy auxiliar buffer
    Set buffer = Nothing
    
    If Error <> 0 Then Err.Raise Error

End Sub


Sub ConnectUser(ByVal Userindex As Integer, _
                ByRef Name As String, _
                ByRef AccountHash As String)

    '***************************************************
    'Autor: Unknown (orginal version)
    'Last Modification: 24/07/2010 (ZaMa)
    '26/03/2009: ZaMa - Agrego por default que el color de dialogo de los dioses, sea como el de su nick.
    '12/06/2009: ZaMa - Agrego chequeo de nivel al loguear
    '14/09/2009: ZaMa - Ahora el usuario esta protegido del ataque de npcs al loguear
    '11/27/2009: Budi - Se envian los InvStats del personaje y su Fuerza y Agilidad
    '03/12/2009: Budi - Optimizacion del codigo
    '24/07/2010: ZaMa - La posicion de comienzo es namehuak, como se habia definido inicialmente.
    '12/10/2019: CHOTS - Sistema de cuentas
    '***************************************************
    Dim n    As Integer

    Dim tStr As String

    With UserList(Userindex)

        If .flags.UserLogged Then
            Call LogCheating("El usuario " & .Name & " ha intentado loguear a " & Name & " desde la IP " & .IP)
            'Kick player ( and leave character inside :D )!
            Call CloseSocketSL(Userindex)
            Call Cerrar_Usuario(Userindex)
            Exit Sub

        End If
    
        'Reseteamos los FLAGS
        .flags.Escondido = 0
        .flags.TargetNPC = 0
        .flags.TargetNpcTipo = eNPCType.Comun
        .flags.TargetObj = 0
        .flags.TargetUser = 0
        .Char.FX = 0
    
        'Controlamos no pasar el maximo de usuarios
        If NumUsers >= MaxUsers Then
            Call WriteErrorMsg(Userindex, "El servidor ha alcanzado el maximo de usuarios soportado, por favor vuelva a intertarlo mas tarde.")
            Call CloseSocket(Userindex)
            Exit Sub

        End If
    
        'Este IP ya esta conectado?
        If AllowMultiLogins = False Then
            If CheckForSameIP(Userindex, .IP) = True Then
                Call WriteErrorMsg(Userindex, "No es posible usar mas de un personaje al mismo tiempo.")
                Call CloseSocket(Userindex)
                Exit Sub

            End If

        End If
    
        'Existe el personaje?
        If Not PersonajeExiste(Name) Then
            Call WriteErrorMsg(Userindex, "El personaje no existe.")
            Call CloseSocket(Userindex)
            Exit Sub

        End If
    
        'Es el passwd valido?
        If Not PersonajePerteneceCuenta(Name, AccountHash) Then
            Call WriteErrorMsg(Userindex, "Ha ocurrido un error, por favor inicie sesion nuevamente.")
            Call CloseSocket(Userindex)
            Exit Sub

        End If
    
        'Ya esta conectado el personaje?
        If CheckForSameName(Name) Then
            If UserList(NameIndex(Name)).Counters.Saliendo Then
                Call WriteErrorMsg(Userindex, "El usuario esta saliendo.")
            Else
                Call WriteErrorMsg(Userindex, "Un usuario con el mismo nombre esta conectado.")
                Call Cerrar_Usuario(NameIndex(Name))
            End If
            Exit Sub

        End If
    
        'Reseteamos los privilegios
        .flags.Privilegios = 0
    
        'Vemos que clase de user es (se lo usa para setear los privilegios al loguear el PJ)
        If EsAdmin(Name) Then
            .flags.Privilegios = .flags.Privilegios Or PlayerType.Admin
            Call LogGM(Name, "Se conecto con ip:" & .IP)
        ElseIf EsDios(Name) Then
            .flags.Privilegios = .flags.Privilegios Or PlayerType.Dios
            Call LogGM(Name, "Se conecto con ip:" & .IP)
        ElseIf EsSemiDios(Name) Then
            .flags.Privilegios = .flags.Privilegios Or PlayerType.SemiDios
        
            .flags.PrivEspecial = EsGmEspecial(Name)
        
            Call LogGM(Name, "Se conecto con ip:" & .IP)
        ElseIf EsConsejero(Name) Then
            .flags.Privilegios = .flags.Privilegios Or PlayerType.Consejero
            Call LogGM(Name, "Se conecto con ip:" & .IP)
        Else
            .flags.Privilegios = .flags.Privilegios Or PlayerType.User
            .flags.AdminPerseguible = True

        End If
    
        'Add RM flag if needed
        If EsRolesMaster(Name) Then
            .flags.Privilegios = .flags.Privilegios Or PlayerType.RoleMaster

        End If
    
        If ServerSoloGMs > 0 Then
            If (.flags.Privilegios And (PlayerType.Admin Or PlayerType.Dios Or PlayerType.SemiDios Or PlayerType.Consejero)) = 0 Then
                Call WriteErrorMsg(Userindex, "Servidor restringido a administradores. Por favor reintente en unos momentos.")
                Call CloseSocket(Userindex)
                Exit Sub

            End If

        End If
    
        'Nombre de sistema
        .Name = Name
    
        'Load the user here
        Call LoadUser(Userindex)

        If Not ValidateChr(Userindex) Then
            Call WriteErrorMsg(Userindex, "Error en el personaje.")
            Call CloseSocket(Userindex)
            Exit Sub

        End If
    
        If .Invent.EscudoEqpSlot = 0 Then .Char.ShieldAnim = NingunEscudo
        If .Invent.CascoEqpSlot = 0 Then .Char.CascoAnim = NingunCasco
        If .Invent.WeaponEqpSlot = 0 Then .Char.WeaponAnim = NingunArma
    
        .CurrentInventorySlots = getMaxInventorySlots(Userindex)

        If (.flags.Muerto = 0) Then
            .flags.SeguroResu = False
            Call WriteMultiMessage(Userindex, eMessages.ResuscitationSafeOff)
        Else
            .flags.SeguroResu = True
            Call WriteMultiMessage(Userindex, eMessages.ResuscitationSafeOn)

        End If
    
        Call UpdateUserInv(True, Userindex, 0)
        Call UpdateUserHechizos(True, Userindex, 0)
                                                                                            
        Call ActualizarSlotAmigo(Userindex, 0, True)
        Call ObtenerIndexAmigos(Userindex, False)
                                                                                            
        If .flags.Paralizado Then
            Call WriteParalizeOK(Userindex)

        End If
    
        Dim Mapa As Integer

        Mapa = .Pos.Map
    
        'Posicion de comienzo
        If Mapa = 0 Then

            'Configurable desde el Server.ini / CustomWorld
            'En caso que usemos mundo propio, cargamos el mapa y la coordeanas donde se hara el spawn inicial'
            'Caso contrario sigue modo Alkon'
            If UsarMundoPropio Then
                .Pos = CustomSpawnMap
                Mapa = CustomSpawnMap.Map
            Else
                'Dejo esto comentado aqui por si se quiere utilizar la ciudad elegida desde el menu
                'Crear personaje, ahora se utiliza solo Nemahuak ya que es una ciudad nw utilizada desde la 0.13
                ' .Pos = Ciudades(.Hogar)
                ' mapa = Ciudades(.Hogar).Map
                .Pos = Nemahuak
                Mapa = Nemahuak.Map
            End If

        Else
    
            If Not MapaValido(Mapa) Then
                Call WriteErrorMsg(Userindex, "El PJ se encuenta en un mapa invalido.")
                Call CloseSocket(Userindex)
                Exit Sub

            End If
        
            ' If map has different initial coords, update it
            Dim StartMap As Integer

            StartMap = MapInfo(Mapa).StartPos.Map

            If StartMap <> 0 Then
                If MapaValido(StartMap) Then
                    .Pos = MapInfo(Mapa).StartPos
                    Mapa = StartMap

                End If

            End If
        
        End If
    
        'Tratamos de evitar en lo posible el "Telefrag". Solo 1 intento de loguear en pos adjacentes.
        'Codigo por Pablo (ToxicWaste) y revisado por Nacho (Integer), corregido para que realmetne ande y no tire el server por Juan Martin Sotuyo Dodero (Maraxus)
        If MapData(Mapa, .Pos.X, .Pos.Y).Userindex <> 0 Or MapData(Mapa, .Pos.X, .Pos.Y).NpcIndex <> 0 Then

            Dim FoundPlace As Boolean

            Dim esAgua     As Boolean

            Dim tX         As Long

            Dim tY         As Long
        
            FoundPlace = False
            esAgua = HayAgua(Mapa, .Pos.X, .Pos.Y)
        
            For tY = .Pos.Y - 1 To .Pos.Y + 1
                For tX = .Pos.X - 1 To .Pos.X + 1

                    If esAgua Then

                        'reviso que sea pos legal en agua, que no haya User ni NPC para poder loguear.
                        If LegalPos(Mapa, tX, tY, True, False) Then
                            FoundPlace = True
                            Exit For

                        End If

                    Else

                        'reviso que sea pos legal en tierra, que no haya User ni NPC para poder loguear.
                        If LegalPos(Mapa, tX, tY, False, True) Then
                            FoundPlace = True
                            Exit For

                        End If

                    End If

                Next tX
            
                If FoundPlace Then Exit For
            Next tY
        
            If FoundPlace Then 'Si encontramos un lugar, listo, nos quedamos ahi
                .Pos.X = tX
                .Pos.Y = tY
            Else

                'Si no encontramos un lugar, sacamos al usuario que tenemos abajo, y si es un NPC, lo pisamos.
                If MapData(Mapa, .Pos.X, .Pos.Y).Userindex <> 0 Then

                    'Si no encontramos lugar, y abajo teniamos a un usuario, lo pisamos y cerramos su comercio seguro
                    If UserList(MapData(Mapa, .Pos.X, .Pos.Y).Userindex).ComUsu.DestUsu > 0 Then

                        'Le avisamos al que estaba comerciando que se tuvo que ir.
                        If UserList(UserList(MapData(Mapa, .Pos.X, .Pos.Y).Userindex).ComUsu.DestUsu).flags.UserLogged Then
                            Call FinComerciarUsu(UserList(MapData(Mapa, .Pos.X, .Pos.Y).Userindex).ComUsu.DestUsu)
                            Call WriteConsoleMsg(UserList(MapData(Mapa, .Pos.X, .Pos.Y).Userindex).ComUsu.DestUsu, "Comercio cancelado. El otro usuario se ha desconectado.", FontTypeNames.FONTTYPE_WARNING)
                        End If

                        'Lo sacamos.
                        If UserList(MapData(Mapa, .Pos.X, .Pos.Y).Userindex).flags.UserLogged Then
                            Call FinComerciarUsu(MapData(Mapa, .Pos.X, .Pos.Y).Userindex)
                            Call WriteErrorMsg(MapData(Mapa, .Pos.X, .Pos.Y).Userindex, "Alguien se ha conectado donde te encontrabas, por favor reconectate...")
                        End If

                    End If
                
                    Call CloseSocket(MapData(Mapa, .Pos.X, .Pos.Y).Userindex)

                End If

            End If

        End If
    
        .showName = True 'Por default los nombres son visibles
    
        'If in the water, and has a boat, equip it!
        If .Invent.BarcoObjIndex > 0 And (HayAgua(Mapa, .Pos.X, .Pos.Y) Or BodyIsBoat(.Char.body)) Then

            .Char.Head = 0

            If .flags.Muerto = 0 Then
                Call ToggleBoatBody(Userindex)
            Else
                .Char.body = iFragataFantasmal
                .Char.ShieldAnim = NingunEscudo
                .Char.WeaponAnim = NingunArma
                .Char.CascoAnim = NingunCasco

            End If
        
            .flags.Navegando = 1

        End If
    
        'Info
        Call WriteUserIndexInServer(Userindex) 'Enviamos el User index
        Call WriteChangeMap(Userindex, .Pos.Map, MapInfo(.Pos.Map).MapVersion) 'Carga el mapa

        'Si tiene MP3 el mapa mandamos que lo reproduzca, sino reproducimos el MIDI de toda la vida
        If MapInfo(.Pos.Map).MusicMp3 <> vbNullString Then
            Call WritePlayMp3(Userindex, MapInfo(.Pos.Map).MusicMp3)
        Else
            Call WritePlayMidi(Userindex, val(ReadField(1, MapInfo(.Pos.Map).Music, 45)))
        End If
        
        If .flags.Privilegios = PlayerType.Dios Then
            .flags.ChatColor = RGB(250, 250, 150)
        ElseIf .flags.Privilegios <> PlayerType.User And .flags.Privilegios <> (PlayerType.User Or PlayerType.ChaosCouncil) And .flags.Privilegios <> (PlayerType.User Or PlayerType.RoyalCouncil) Then
            .flags.ChatColor = RGB(0, 255, 0)
        ElseIf .flags.Privilegios = (PlayerType.User Or PlayerType.RoyalCouncil) Then
            .flags.ChatColor = RGB(0, 255, 255)
        ElseIf .flags.Privilegios = (PlayerType.User Or PlayerType.ChaosCouncil) Then
            .flags.ChatColor = RGB(255, 128, 64)
        Else
            .flags.ChatColor = vbWhite

        End If
    
        ''[EL OSO]: TRAIGO ESTO ACA ARRIBA PARA DARLE EL IP!
        #If ConUpTime Then
            .LogOnTime = Now
        #End If
    
        'Crea  el personaje del usuario
        If (.flags.Privilegios And (PlayerType.User Or PlayerType.RoleMaster)) = 0 Then
            Call DoAdminInvisible(Userindex)
            .flags.SendDenounces = True
        End If
        Call MakeUserChar(True, .Pos.Map, Userindex, .Pos.Map, .Pos.X, .Pos.Y)
    
        Call WriteUserCharIndexInServer(Userindex)
        ''[/el oso]
    
        Call DoTileEvents(Userindex, .Pos.Map, .Pos.X, .Pos.Y)
    
        Call CheckUserLevel(Userindex)
        Call WriteUpdateUserStats(Userindex)
    
        Call WriteUpdateHungerAndThirst(Userindex)
        Call WriteUpdateStrenghtAndDexterity(Userindex)
        
        Call SendMOTD(Userindex)
    
        If haciendoBK Then
            Call WritePauseToggle(Userindex)
            Call WriteConsoleMsg(Userindex, "Servidor> Por favor espera algunos segundos, el WorldSave esta ejecutandose.", FontTypeNames.FONTTYPE_SERVER)

        End If
    
        If EnPausa Then
            Call WritePauseToggle(Userindex)
            Call WriteConsoleMsg(Userindex, "Servidor> Lo sentimos mucho pero el servidor se encuentra actualmente detenido. Intenta ingresar mas tarde.", FontTypeNames.FONTTYPE_SERVER)

        End If
    
        If EnTesting And .Stats.ELV >= 18 Then
            Call WriteErrorMsg(Userindex, "Servidor en Testing por unos minutos, conectese con PJs de nivel menor a 18. No se conecte con Pjs que puedan resultar importantes por ahora pues pueden arruinarse.")
            Call CloseSocket(Userindex)
            Exit Sub

        End If
    
        'Actualiza el Num de usuarios
        'DE ACA EN ADELANTE GRABA EL CHARFILE, OJO!
        NumUsers = NumUsers + 1
        .flags.UserLogged = True
    
        'usado para borrar Pjs
        Call UpdateUserLogged(.Name, 1)
    
    
        MapInfo(.Pos.Map).NumUsers = MapInfo(.Pos.Map).NumUsers + 1
    
        If .Stats.SkillPts > 0 Then
            Call WriteSendSkills(Userindex)
            Call WriteLevelUp(Userindex, .Stats.SkillPts)

        End If
    
        If NumUsers > RecordUsuariosOnline Then
            Call SendData(SendTarget.ToAll, 0, PrepareMessageConsoleMsg("Record de usuarios conectados simultaneamente. Hay " & NumUsers & " usuarios.", FontTypeNames.FONTTYPE_INFOBOLD))
            RecordUsuariosOnline = NumUsers
            Call WriteVar(IniPath & "Server.ini", "INIT", "RECORD", Str(RecordUsuariosOnline))

            'Este ultimo es para saber siempre los records en el frmMain
            frmMain.txtRecordOnline.Text = RecordUsuariosOnline
        End If
    
        If .NroMascotas > 0 And MapInfo(.Pos.Map).Pk Then

            Dim i As Integer

            For i = 1 To MAXMASCOTAS

                If .MascotasType(i) > 0 Then
                    .MascotasIndex(i) = SpawnNpc(.MascotasType(i), .Pos, True, True)
                
                    If .MascotasIndex(i) > 0 Then
                        Npclist(.MascotasIndex(i)).MaestroUser = Userindex
                        Call FollowAmo(.MascotasIndex(i))
                    Else
                        .MascotasIndex(i) = 0

                    End If

                End If

            Next i

        End If
    
        If .flags.Navegando = 1 Then
            Call WriteNavigateToggle(Userindex)

        End If
    
        If criminal(Userindex) Then
            Call WriteMultiMessage(Userindex, eMessages.SafeModeOff) 'Call WriteSafeModeOff(UserIndex)
            .flags.Seguro = False
        Else
            .flags.Seguro = True
            Call WriteMultiMessage(Userindex, eMessages.SafeModeOn) 'Call WriteSafeModeOn(UserIndex)

        End If
    
        If .GuildIndex > 0 Then

            'welcome to the show baby...
            If Not modGuilds.m_ConectarMiembroAClan(Userindex, .GuildIndex) Then
                Call WriteConsoleMsg(Userindex, "Tu estado no te permite entrar al clan.", FontTypeNames.FONTTYPE_GUILD)

            End If

        End If
    
        Call SendData(SendTarget.ToPCArea, Userindex, PrepareMessageCreateFX(.Char.CharIndex, FXIDs.FXWARP, 0))
    
        Call WriteLoggedMessage(Userindex)

        If (.flags.Muerto = 0) Then
            .flags.SeguroResu = False
            Call WriteMultiMessage(Userindex, eMessages.ResuscitationSafeOff)
        Else
            .flags.SeguroResu = True
            Call WriteMultiMessage(Userindex, eMessages.ResuscitationSafeOn)
        End If

        If criminal(Userindex) Then
            Call WriteMultiMessage(Userindex, eMessages.SafeModeOff) 'Call WriteSafeModeOff(UserIndex)
            .flags.Seguro = False
        Else
            .flags.Seguro = True
            Call WriteMultiMessage(Userindex, eMessages.SafeModeOn) 'Call WriteSafeModeOn(UserIndex)
        End If
    
        ' Esta protegido del ataque de npcs por 5 segundos, si no realiza ninguna accion
        Call IntervaloPermiteSerAtacado(Userindex, True)
    
        If Lloviendo Then
            Call WriteRainToggle(Userindex)

        End If
    
        tStr = modGuilds.a_ObtenerRechazoDeChar(.Name)
    
        If LenB(tStr) <> 0 Then
            Call WriteShowMessageBox(Userindex, "Tu solicitud de ingreso al clan ha sido rechazada. El clan te explica que: " & tStr)

        End If
    
        'Load the user statistics
        Call Statistics.UserConnected(Userindex)
    
        Call MostrarNumUsers
        
        Call modGuilds.SendGuildNews(Userindex)
        
        'Aqui solo vamos a hacer un request a los endpoints de la aplicacion en Node.js
        'el repositorio para hacer funcionar esto, es este: https://github.com/ao-libre/ao-api-server
        'Si no tienen interes en usarlo pueden desactivarlo en el Server.ini
        If ConexionAPI Then
            Call ApiEndpointSendUserConnectedMessageDiscord(Name, .Desc, criminal(Userindex), ListaClases(.Clase))
        End If

        n = FreeFile
        Open App.Path & "\logs\numusers.log" For Output As n
        Print #n, NumUsers
        Close #n
    
        n = FreeFile
        'Log
        Open App.Path & "\logs\Connect.log" For Append Shared As #n
        Print #n, .Name & " ha entrado al juego. UserIndex:" & Userindex & " " & time & " " & Date
        Close #n

    End With

End Sub