Private Sub HandleLeftClick(ByVal Userindex As Integer)

    '***************************************************
    'Author: Juan Martin Sotuyo Dodero (Maraxus)
    'Last Modification: 05/17/06
    '
    '***************************************************
    If UserList(Userindex).incomingData.Length < 3 Then
        Err.Raise UserList(Userindex).incomingData.NotEnoughDataErrCode
        Exit Sub

    End If
    
    With UserList(Userindex).incomingData
        'Remove packet ID
        Call .ReadByte
        
        Dim X As Byte

        Dim Y As Byte
        
        X = .ReadByte()
        Y = .ReadByte()
        
        Call LookatTile(Userindex, UserList(Userindex).Pos.Map, X, Y)

    End With

End Sub


Sub LookatTile(ByVal Userindex As Integer, _
               ByVal Map As Integer, _
               ByVal X As Integer, _
               ByVal Y As Integer)
    '***************************************************
    'Autor: Unknown (orginal version)
    'Last Modification: 05/01/2020
    '13/02/2009: ZaMa - El nombre del gm que aparece por consola al clickearlo, tiene el color correspondiente a su rango
    '05/01/2020: Recox - Ahora mostramos mucha mas informacion de los personajes, como clan, nivel, vida, etc al hacerles click
    '***************************************************

    On Error GoTo ErrHandler

    'Responde al click del usuario sobre el mapa
    Dim FoundChar      As Byte

    Dim FoundSomething As Byte

    Dim TempCharIndex  As Integer

    Dim Stat           As String

    Dim ft             As FontTypeNames

    With UserList(Userindex)

        'Rango Vision? (ToxicWaste)
        If (Abs(.Pos.Y - Y) > RANGO_VISION_Y) Or (Abs(.Pos.X - X) > RANGO_VISION_X) Then
            Exit Sub

        End If
    
        'Posicion valida?
        If InMapBounds(Map, X, Y) Then

            With .flags
                .TargetMap = Map
                .TargetX = X
                .TargetY = Y

                'Es un obj?
                If MapData(Map, X, Y).ObjInfo.ObjIndex > 0 Then
                    'Informa el nombre
                    .TargetObjMap = Map
                    .TargetObjX = X
                    .TargetObjY = Y
                    FoundSomething = 1
                ElseIf MapData(Map, X + 1, Y).ObjInfo.ObjIndex > 0 Then

                    'Informa el nombre
                    If ObjData(MapData(Map, X + 1, Y).ObjInfo.ObjIndex).OBJType = eOBJType.otPuertas Then
                        .TargetObjMap = Map
                        .TargetObjX = X + 1
                        .TargetObjY = Y
                        FoundSomething = 1

                    End If

                ElseIf MapData(Map, X + 1, Y + 1).ObjInfo.ObjIndex > 0 Then

                    If ObjData(MapData(Map, X + 1, Y + 1).ObjInfo.ObjIndex).OBJType = eOBJType.otPuertas Then
                        'Informa el nombre
                        .TargetObjMap = Map
                        .TargetObjX = X + 1
                        .TargetObjY = Y + 1
                        FoundSomething = 1

                    End If

                ElseIf MapData(Map, X, Y + 1).ObjInfo.ObjIndex > 0 Then

                    If ObjData(MapData(Map, X, Y + 1).ObjInfo.ObjIndex).OBJType = eOBJType.otPuertas Then
                        'Informa el nombre
                        .TargetObjMap = Map
                        .TargetObjX = X
                        .TargetObjY = Y + 1
                        FoundSomething = 1

                    End If

                End If
            
                If FoundSomething = 1 Then
                    .TargetObj = MapData(Map, .TargetObjX, .TargetObjY).ObjInfo.ObjIndex

                    If MostrarCantidad(.TargetObj) Then
                        Call WriteConsoleMsg(Userindex, ObjData(.TargetObj).Name & " - " & MapData(.TargetObjMap, .TargetObjX, .TargetObjY).ObjInfo.Amount & "", FontTypeNames.FONTTYPE_INFO)
                    Else
                        Call WriteConsoleMsg(Userindex, ObjData(.TargetObj).Name, FontTypeNames.FONTTYPE_INFO)

                    End If
            
                End If

                'Es un personaje?
                If Y + 1 <= YMaxMapSize Then
                    If MapData(Map, X, Y + 1).Userindex > 0 Then
                        TempCharIndex = MapData(Map, X, Y + 1).Userindex
                        FoundChar = 1

                    End If

                    If MapData(Map, X, Y + 1).NpcIndex > 0 Then
                        TempCharIndex = MapData(Map, X, Y + 1).NpcIndex
                        FoundChar = 2

                    End If

                End If

                'Es un personaje?
                If FoundChar = 0 Then
                    If MapData(Map, X, Y).Userindex > 0 Then
                        TempCharIndex = MapData(Map, X, Y).Userindex
                        FoundChar = 1

                    End If

                    If MapData(Map, X, Y).NpcIndex > 0 Then
                        TempCharIndex = MapData(Map, X, Y).NpcIndex
                        FoundChar = 2

                    End If

                End If

            End With
    
            'Reaccion al personaje
            If FoundChar = 1 Then '  Encontro un Usuario?
                If UserList(TempCharIndex).flags.AdminInvisible = 0 Or .flags.Privilegios And PlayerType.Dios Then

                    With UserList(TempCharIndex)

                        If LenB(.DescRM) = 0 And .showName Then 'No tiene descRM y quiere que se vea su nombre.
                            If EsNewbie(TempCharIndex) Then
                                Stat = Stat & " <NEWBIE>"

                            End If
                        
                            If .Faccion.ArmadaReal = 1 Then
                                Stat = Stat & " <Ejercito Real> " & "<" & TituloReal(TempCharIndex) & ">"
                            ElseIf .Faccion.FuerzasCaos = 1 Then
                                Stat = Stat & " <Legion Oscura> " & "<" & TituloCaos(TempCharIndex) & ">"

                            End If
                        
                            If .GuildIndex > 0 Then
                                Stat = Stat & " Clan: '" & modGuilds.GuildName(.GuildIndex) & "'"

                            End If

                            Stat = Stat & " Nivel: " & UserList(TempCharIndex).Stats.ELV

                            'Aqui ponemos o no la descripcion si tiene
                            If Len(UserList(TempCharIndex).Desc) > 1 Then
                                Stat = UserList(TempCharIndex).Name & " - " & UserList(TempCharIndex).Desc & " (" & ListaClases(UserList(TempCharIndex).Clase) & " " & ListaRazas(UserList(TempCharIndex).raza) & Stat & "  " & " | "
                            Else
                                Stat = UserList(TempCharIndex).Name & " (" & ListaClases(UserList(TempCharIndex).Clase) & " " & ListaRazas(UserList(TempCharIndex).raza) & Stat & " " & " | "
                            End If

                            'Aqui le damos informacion sobre el estado de salud del pj.
                            If UserList(TempCharIndex).Stats.MinHp < (UserList(TempCharIndex).Stats.MaxHp * 0.05) Then
                                Stat = Stat & " Muerto)"
                            ElseIf UserList(TempCharIndex).Stats.MinHp < (UserList(TempCharIndex).Stats.MaxHp * 0.1) Then
                                Stat = Stat & " Casi muerto)"
                            ElseIf UserList(TempCharIndex).Stats.MinHp < (UserList(TempCharIndex).Stats.MaxHp * 0.25) Then
                                Stat = Stat & " Muy Malherido)"
                            ElseIf UserList(TempCharIndex).Stats.MinHp < (UserList(TempCharIndex).Stats.MaxHp * 0.5) Then
                                Stat = Stat & " Malherido)"
                            ElseIf UserList(TempCharIndex).Stats.MinHp < (UserList(TempCharIndex).Stats.MaxHp * 0.75) Then
                                Stat = Stat & " Herido)"
                            ElseIf UserList(TempCharIndex).Stats.MinHp < (UserList(TempCharIndex).Stats.MaxHp) Then
                                Stat = Stat & " Levemente Herido)"
                            Else
                                Stat = Stat & " Intacto)"
                            End If
                                        
                            If .flags.Privilegios And PlayerType.RoyalCouncil Then
                                Stat = Stat & " [CONSEJO DE BANDERBILL]"
                                ft = FontTypeNames.FONTTYPE_CONSEJOVesA
                            ElseIf .flags.Privilegios And PlayerType.ChaosCouncil Then
                                Stat = Stat & " [CONCILIO DE LAS SOMBRAS]"
                                ft = FontTypeNames.FONTTYPE_CONSEJOCAOSVesA
                            Else

                                If Not .flags.Privilegios And PlayerType.User Then
                                    Stat = Stat & " <GAME MASTER>"
                                
                                    ' Elijo el color segun el rango del GM:
                                    ' Dios
                                    If .flags.Privilegios = PlayerType.Dios Then
                                        ft = FontTypeNames.FONTTYPE_DIOS
                                        ' Gm
                                    ElseIf .flags.Privilegios = PlayerType.SemiDios Then
                                        ft = FontTypeNames.FONTTYPE_GM
                                        ' Conse
                                    ElseIf .flags.Privilegios = PlayerType.Consejero Then
                                        ft = FontTypeNames.FONTTYPE_CONSEJO
                                        ' Rm o Dsrm
                                    ElseIf .flags.Privilegios = (PlayerType.RoleMaster Or PlayerType.Consejero) Or .flags.Privilegios = (PlayerType.RoleMaster Or PlayerType.Dios) Then
                                        ft = FontTypeNames.FONTTYPE_EJECUCION

                                    End If
                                
                                ElseIf criminal(TempCharIndex) Then
                                    Stat = Stat & " <CRIMINAL>"
                                    ft = FontTypeNames.FONTTYPE_CRIMINAL
                                Else
                                    Stat = Stat & " <CIUDADANO>"
                                    ft = FontTypeNames.FONTTYPE_CITIZEN

                                End If

                            End If

                        End If

                    End With
                
                    If LenB(Stat) > 0 Then
                        Call WriteConsoleMsg(Userindex, Stat, ft)

                    End If
                
                    FoundSomething = 1
                    .flags.TargetUser = TempCharIndex
                    .flags.TargetNPC = 0
                    .flags.TargetNpcTipo = eNPCType.Comun

                Else  'Si tiene descRM la muestro siempre.
                    Stat = .DescRM
                    ft = FontTypeNames.FONTTYPE_INFOBOLD
                End If

            End If
    
            With .flags

                If FoundChar = 2 Then 'Encontro un NPC?

                    Dim estatus            As String
                    Dim MinHp              As Long
                    Dim MaxHp              As Long
                    Dim SupervivenciaSkill As Byte
                    Dim sDesc              As String
                    Dim TimeParalizado     As String
                
                    MinHp = Npclist(TempCharIndex).Stats.MinHp
                    MaxHp = Npclist(TempCharIndex).Stats.MaxHp
                    SupervivenciaSkill = UserList(Userindex).Stats.UserSkills(eSkill.Supervivencia)
                
                    If .Privilegios And (PlayerType.SemiDios Or PlayerType.Dios Or PlayerType.Admin) Then
                        estatus = "(" & MinHp & "/" & MaxHp & ") "
                    Else

                        If .Muerto = 0 Then
                    
                            If SupervivenciaSkill <= 10 Then
                                estatus = "(Dudoso) "
                            
                            ElseIf SupervivenciaSkill <= 20 Then

                                If MinHp < (MaxHp / 2) Then
                                    estatus = "(Herido) "
                                Else
                                    estatus = "(Sano) "

                                End If
                            
                            ElseIf SupervivenciaSkill <= 30 Then

                                If MinHp < (MaxHp * 0.5) Then
                                    estatus = "(Malherido) "
                                ElseIf MinHp < (MaxHp * 0.75) Then
                                    estatus = "(Herido) "
                                Else
                                    estatus = "(Sano) "

                                End If
                            
                            ElseIf SupervivenciaSkill <= 40 Then

                                If MinHp < (MaxHp * 0.25) Then
                                    estatus = "(Muy malherido) "
                                ElseIf MinHp < (MaxHp * 0.5) Then
                                    estatus = "(Herido) "
                                ElseIf MinHp < (MaxHp * 0.75) Then
                                    estatus = "(Levemente herido) "
                                Else
                                    estatus = "(Sano) "

                                End If
                            
                            ElseIf SupervivenciaSkill < 60 Then

                                If MinHp < (MaxHp * 0.05) Then
                                    estatus = "(Agonizando) "
                                ElseIf MinHp < (MaxHp * 0.1) Then
                                    estatus = "(Casi muerto) "
                                ElseIf MinHp < (MaxHp * 0.25) Then
                                    estatus = "(Muy Malherido) "
                                ElseIf MinHp < (MaxHp * 0.5) Then
                                    estatus = "(Herido) "
                                ElseIf MinHp < (MaxHp * 0.75) Then
                                    estatus = "(Levemente herido) "
                                ElseIf MinHp < (MaxHp) Then
                                    estatus = "(Sano) "
                                Else
                                    estatus = "(Intacto) "

                                End If

                            Else
                                estatus = "(" & MinHp & "/" & MaxHp & ") "

                            End If

                        End If

                    End If
                    
                    'Lorwik> Tiene 100 skills en supervivencia?
                    If UserList(Userindex).Stats.UserSkills(eSkill.Supervivencia) = 100 Then

                        'Lorwik> Esta paralizado o inmovilizado? Si lo esta miramos el tiempo que le queda.
                        If Npclist(TempCharIndex).flags.Paralizado = 1 Or Npclist(TempCharIndex).flags.Inmovilizado = 1 Then
                            TimeParalizado = " - Tiempo de paralisis: " & Npclist(TempCharIndex).Contadores.Paralisis & " segundos."
                        End If
                        
                    End If
                    
                    If Len(Npclist(TempCharIndex).Desc) > 1 Then
                        Stat = Npclist(TempCharIndex).Desc
                    
                        'Es el rey o el demonio?
                        If Npclist(TempCharIndex).NPCtype = eNPCType.Noble Then
                            If Npclist(TempCharIndex).flags.Faccion = 0 Then 'Es el Rey.

                                'Si es de la Legion Oscura y usuario comun mostramos el mensaje correspondiente y lo ejecutamos:
                                If UserList(Userindex).Faccion.FuerzasCaos = 1 Then
                                    Stat = MENSAJE_REY_CAOS

                                    If .Privilegios And PlayerType.User Then
                                        If .Muerto = 0 Then Call UserDie(Userindex)

                                    End If

                                ElseIf criminal(Userindex) Then

                                    'Nos fijamos si es criminal enlistable o no enlistable:
                                    If UserList(Userindex).Faccion.CiudadanosMatados > 0 Or UserList(Userindex).Faccion.Reenlistadas > 4 Then 'Es criminal no enlistable.
                                        Stat = MENSAJE_REY_CRIMINAL_NOENLISTABLE
                                    Else 'Es criminal enlistable.
                                        Stat = MENSAJE_REY_CRIMINAL_ENLISTABLE

                                    End If

                                End If

                            Else 'Es el demonio

                                'Si es de la Armada Real y usuario comun mostramos el mensaje correspondiente y lo ejecutamos:
                                If UserList(Userindex).Faccion.ArmadaReal = 1 Then
                                    Stat = MENSAJE_DEMONIO_REAL

                                    '
                                    If .Privilegios And PlayerType.User Then
                                        If .Muerto = 0 Then Call UserDie(Userindex)

                                    End If

                                ElseIf Not criminal(Userindex) Then

                                    'Nos fijamos si es ciudadano enlistable o no enlistable:
                                    If UserList(Userindex).Faccion.RecibioExpInicialReal = 1 Or UserList(Userindex).Faccion.Reenlistadas > 4 Then 'Es ciudadano no enlistable.
                                        Stat = MENSAJE_DEMONIO_CIUDADANO_NOENLISTABLE
                                    Else 'Es ciudadano enlistable.
                                        Stat = MENSAJE_DEMONIO_CIUDADANO_ENLISTABLE

                                    End If

                                End If

                            End If

                        End If
                    
                        'Enviamos el mensaje propiamente dicho:
                        Call WriteChatOverHead(Userindex, Stat, Npclist(TempCharIndex).Char.CharIndex, vbWhite)
                    Else

                        If Npclist(TempCharIndex).MaestroUser > 0 Then
                            Call WriteConsoleMsg(Userindex, estatus & Npclist(TempCharIndex).Name & " es mascota de " & UserList(Npclist(TempCharIndex).MaestroUser).Name & TimeParalizado, FontTypeNames.FONTTYPE_INFO)
                        
                        Else
                            Call WriteConsoleMsg(Userindex, estatus & Npclist(TempCharIndex).Name & TimeParalizado, FontTypeNames.FONTTYPE_INFO)
                            
                            If Len(Npclist(TempCharIndex).flags.AttackedFirstBy) > 0 And (UserList(Userindex).flags.Privilegios And (PlayerType.Dios Or PlayerType.Admin)) Then
                                Call WriteConsoleMsg(Userindex, "Le pego primero: " & Npclist(TempCharIndex).flags.AttackedFirstBy & ".", FontTypeNames.FONTTYPE_INFO)
                            End If
                        End If
                        
                    End If
                
                    FoundSomething = 1
                    .TargetNpcTipo = Npclist(TempCharIndex).NPCtype
                    .TargetNPC = TempCharIndex
                    .TargetUser = 0
                    .TargetObj = 0

                End If
            
                If FoundChar = 0 Then
                    .TargetNPC = 0
                    .TargetNpcTipo = eNPCType.Comun
                    .TargetUser = 0

                End If
            
                '*** NO ENCOTRO NADA ***
                If FoundSomething = 0 Then
                    .TargetNPC = 0
                    .TargetNpcTipo = eNPCType.Comun
                    .TargetUser = 0
                    .TargetObj = 0
                    .TargetObjMap = 0
                    .TargetObjX = 0
                    .TargetObjY = 0

                End If

            End With

        Else

            If FoundSomething = 0 Then

                With .flags
                    .TargetNPC = 0
                    .TargetNpcTipo = eNPCType.Comun
                    .TargetUser = 0
                    .TargetObj = 0
                    .TargetObjMap = 0
                    .TargetObjX = 0
                    .TargetObjY = 0

                End With

            End If

        End If

    End With

    Exit Sub